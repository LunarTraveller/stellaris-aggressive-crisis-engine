namespace = acemod_crisis_manager
# INITIALISERS
# Marks ACE Crisis Manager mod as present. Other mods can check against this flag to see if ACE Crisis Manager is installed.
country_event = {
	id = acemod_core.100
	hide_window = yes
	fire_only_once = yes
	trigger = {
		is_ai = no
	}
	immediate = {
		set_global_flag = acemod_crisis_manager_installed
	}
}

# MENU
# Crisis Manager window
country_event = {
	id = acemod_crisis_manager.1
	title = acemod_crisis_manager.1.name
	desc = acemod_crisis_manager.1.desc
	picture = GFX_evt_ground_combat
	is_triggered_only = yes
	option = {
		name = acemod_crisis_manager.1.a
		custom_tooltip = acemod_crisis_manager.1.a.tooltip
		hidden_effect = {
			if = {
				limit = {
					always = no
					# NOT = {
					# 	has_global_flag = acemod_crisis_manager_active
					# }
				}
				set_global_flag = acemod_crisis_manager_active
				country_event = {
					id = acemod_crisis_manager.1
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				# remove_global_flag = acemod_crisis_manager_active
				country_event = {
					id = acemod_crisis_manager.1
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	option = {
		name = acemod_crisis_manager.1.b
		custom_tooltip = acemod_crisis_manager.1.b.tooltip
		hidden_effect = {
			country_event = {
				id = acemod_crisis_manager.1
				days = 0
				random = 0
			}
			country_event = {
				id = acemod_crisis_manager.2				# Gathers and shows information about galaxy as configured in the game lobby.
				days = 0
				random = 0
			}
		}
	}
	option = {
		name = acemod_crisis_manager.1.c
		custom_tooltip = acemod_crisis_manager.1.c.tooltip
		hidden_effect = {
			country_event = {
				id = acemod_crisis_manager.1
				days = 0
				random = 0
			}
			country_event = {
				id = acemod_crisis_manager.5				# Debugging tool.
				days = 0
				random = 0
			}
		}
	}
	option = {
		name = acemod_crisis_manager.1.d		# Prethoryn spawn
		custom_tooltip = acemod_crisis_manager.1.d.tooltip
		hidden_effect = {
			event_target:global_event_country = {
				# global_event country is always around
				if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 0
						}
					}
					change_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = 5
					}
				}
				if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 404
						}
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_prethoryn_spawn_time
						value = 0
					}
				}
				else = {
					change_variable = {
						which = acemod_crisis_manager_var_country_prethoryn_spawn_time
						value = acemod_crisis_manager_var_country_spawn_time_variable
					}
				}
				root = {
					set_variable = {
						which = acemod_crisis_manager_var_country_prethoryn_spawn_time
						value = prev
					}
					country_event = {
						id = acemod_crisis_manager.1
						days = 0
						random = 0
					}
				}
			}
		}
	}
	option = {
		name = acemod_crisis_manager.1.e		# Extradimensional spawn
		custom_tooltip = acemod_crisis_manager.1.e.tooltip
		hidden_effect = {
			event_target:global_event_country = {
				# global_event country is always around
				if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 0
						}
					}
					change_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = 5
					}
				}
				if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 404
						}
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_extradimensional_spawn_time
						value = 0
					}
				}
				else = {
					change_variable = {
						which = acemod_crisis_manager_var_country_extradimensional_spawn_time
						value = acemod_crisis_manager_var_country_spawn_time_variable
					}
				}
				root = {
					set_variable = {
						which = acemod_crisis_manager_var_country_extradimensional_spawn_time
						value = prev
					}
					country_event = {
						id = acemod_crisis_manager.1
						days = 0
						random = 0
					}
				}
			}
		}
	}
	option = {
		name = acemod_crisis_manager.1.f		# Contingency spawn
		custom_tooltip = acemod_crisis_manager.1.f.tooltip
		hidden_effect = {
			event_target:global_event_country = {
				# global_event country is always around
				if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 0
						}
					}
					change_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = 5
					}
				}
				if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 404
						}
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_contingency_spawn_time
						value = 0
					}
				}
				else = {
					change_variable = {
						which = acemod_crisis_manager_var_country_contingency_spawn_time
						value = acemod_crisis_manager_var_country_spawn_time_variable
					}
				}
				root = {
					set_variable = {
						which = acemod_crisis_manager_var_country_contingency_spawn_time
						value = prev
					}
					country_event = {
						id = acemod_crisis_manager.1
						days = 0
						random = 0
					}
				}
			}
		}
	}
	option = {
		name = acemod_crisis_manager.1.g
		custom_tooltip = acemod_crisis_manager.1.g.tooltip
		hidden_effect = {
			event_target:global_event_country = {
				# global_event country is always around
				if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 0
						}
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = 5
					}
				}
				if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 5
						}
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = 10
					}
				}
				else_if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 10
						}
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = 20
					}
				}
				else_if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 20
						}
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = 50
					}
				}
				else_if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 50
						}
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = 100
					}
				}
				else_if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 100
						}
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = 404
					}
				}
				else_if = {
					limit = {
						check_variable = {
							which = acemod_crisis_manager_var_country_spawn_time_variable
							value = 404
						}
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = 5
					}
				}
				else = {
					set_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = 5
					}
				}
				root = {
					set_variable = {
						which = acemod_crisis_manager_var_country_spawn_time_variable
						value = prev
					}
					country_event = {
						id = acemod_crisis_manager.1
						days = 0
						random = 0
					}
				}
			}
		}
	}
	option = {
		name = acemod_crisis_manager.1.z
		custom_tooltip = acemod_crisis_manager.1.z.tooltip
		hidden_effect = {
			country_event = {
				id = acemod_menu.1				# Closes Crisis Manager window and redirects to main menu.
				days = 0
				random = 0
			}
		}
	}
}

# Gathers information about galaxy as configured in the game lobby.
country_event = {
	id = acemod_crisis_manager.2
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
			country_event = {
				id = acemod_crisis_manager.3				# Gathers information about galaxy as configured in the game lobby.
				days = 0
				random = 0
			}
			country_event = {
				id = acemod_crisis_manager.4				# Shows information about galaxy as configured in the game lobby.
				days = 0
				random = 0
			}
		}
	}
}

# Gathers information about galaxy as configured in the game lobby.
country_event = {
	id = acemod_crisis_manager.3
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
			event_target:global_event_country = {
				# global_event country is always around
				# acemod_crisis_manager_var_country_is_checksum_modified
				if = {
					limit = {
						always = no						# Unable to grab this value but modded events change checksum (this file).
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_is_checksum_modified
						value = 0
					}
				}
				else = {
					set_variable = {
						which = acemod_crisis_manager_var_country_is_checksum_modified
						value = 1
					}
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_is_checksum_modified
						value = prev
					}
				}
			}
			event_target:global_event_country = {
				# global_event country is always around
				# acemod_crisis_manager_var_country_is_ironman
				if = {
					limit = {
						is_ironman = yes
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_is_ironman
						value = 1
					}
				}
				else = {
					set_variable = {
						which = acemod_crisis_manager_var_country_is_ironman
						value = 0
					}
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_is_ironman
						value = prev
					}
				}
			}
			event_target:global_event_country = {
				# global_event country is always around
				# acemod_crisis_manager_var_country_is_multiplayer
				if = {
					limit = {
						is_multiplayer = yes
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_is_multiplayer
						value = 1
					}
				}
				else = {
					set_variable = {
						which = acemod_crisis_manager_var_country_is_multiplayer
						value = 0
					}
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_is_multiplayer
						value = prev
					}
				}
			}
			event_target:global_event_country = {
				# global_event country is always around
				# acemod_crisis_manager_var_country_achievements_disabled
				if = {
					limit = {
						OR = {
							check_variable = {
								which = acemod_crisis_manager_var_country_is_checksum_modified								# Achievements cannot be obtained with modified checksum.
								value = 1
							}
							NOT = {
								check_variable = {
									which = acemod_crisis_manager_var_country_is_ironman									# Achievements require ironman mode.
									value = 1
								}
							}
							check_variable = {
								which = acemod_crisis_manager_var_country_is_multiplayer								# Achievements cannot be obtained in multiplayer.
								value = 1
							}
						}
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_achievements_disabled
						value = 1
					}
				}
				else = {
					set_variable = {
						which = acemod_crisis_manager_var_country_achievements_disabled
						value = 0
					}
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_achievements_disabled
						value = prev
					}
				}
			}
			event_target:global_event_country = {
				# global_event country is always around
				# GALAXY_SIZE
				set_variable = {
					which = acemod_crisis_manager_var_country_num_systems
					value = 0
				}
				every_system = {
					limit = {
						always = yes
					}
					event_target:global_event_country = {
						change_variable = {
							which = acemod_crisis_manager_var_country_num_systems
							value = 1
						}
					}
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_num_systems
						value = prev
					}
				}
			}
			event_target:global_event_country = {
				# global_event country is always around
				# get_galaxy_setup_value effect
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_num_empires
					setting = num_empires
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_num_advanced_empires
					setting = num_advanced_empires
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_num_fallen_empires
					setting = num_fallen_empires
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_num_marauder_empires
					setting = num_marauder_empires
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_mid_game_year
					setting = mid_game_year
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_end_game_year
					setting = end_game_year
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_victory_year
					setting = victory_year
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_num_guaranteed_colonies
					setting = num_guaranteed_colonies
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_num_gateways
					setting = num_gateways
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_num_wormhole_pairs
					setting = num_wormhole_pairs
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_num_hyperlanes
					setting = num_hyperlanes
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_habitable_worlds_scale
					setting = habitable_worlds_scale
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_primitive_worlds_scale
					setting = primitive_worlds_scale
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_crisis_strength_scale
					setting = crisis_strength_scale
				}
				get_galaxy_setup_value = {
					which = acemod_crisis_manager_var_country_tech_costs_scale
					setting = tech_costs_scale
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_num_empires
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_num_advanced_empires
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_num_fallen_empires
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_num_marauder_empires
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_mid_game_year
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_end_game_year
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_victory_year
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_num_guaranteed_colonies
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_num_wormhole_pairs
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_num_hyperlanes
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_habitable_worlds_scale
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_primitive_worlds_scale
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_crisis_strength_scale
						value = prev
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_tech_costs_scale
						value = prev
					}
				}
			}
			event_target:global_event_country = {
				# global_event country is always around
				# FE_DIFFICULTY
				if = {
					limit = {
						is_difficulty = 0
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_is_difficulty
						value = 0.5
					}
					# break = yes
				}
				else_if = {
					limit = {
						is_difficulty = 1
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_is_difficulty
						value = 1
					}
					# break = yes
				}
				else_if = {
					limit = {
						is_difficulty = 2
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_is_difficulty
						value = 2
					}
					# break = yes
				}
				else_if = {
					limit = {
						is_difficulty = 3
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_is_difficulty
						value = 3
					}
					# break = yes
				}
				else_if = {
					limit = {
						is_difficulty = 4
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_is_difficulty
						value = 4
					}
					# break = yes
				}
				else_if = {
					limit = {
						is_difficulty = 5
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_is_difficulty
						value = 5
					}
					# break = yes
				}
				else = {
					set_variable = {
						which = acemod_crisis_manager_var_country_is_difficulty
						value = 404
					}
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_is_difficulty
						value = prev
					}
				}
			}
			# GALAXY_SHAPE - unobtainable
			event_target:global_event_country = {
				set_variable = {
					which = acemod_crisis_manager_var_country_setup_scenario
					value = 404
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_setup_scenario
						value = prev
					}
				}
			}
			# FE_SCALING_DIFFICULTY - unobtainable
			event_target:global_event_country = {
				set_variable = {
					which = acemod_crisis_manager_var_country_scaling_difficulty
					value = 404
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_scaling_difficulty
						value = prev
					}
				}
			}
			# FE_AGGRESSIVENESS - unobtainable
			event_target:global_event_country = {
				set_variable = {
					which = acemod_crisis_manager_var_country_aggressiveness
					value = 404
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_aggressiveness
						value = prev
					}
				}
			}
			# FE_ADVANCED_NEAR_PLAYER - unobtainable
			event_target:global_event_country = {
				set_variable = {
					which = acemod_crisis_manager_var_country_advanced_neighbors
					value = 404
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_advanced_neighbors
						value = prev
					}
				}
			}
			# FE_CLUSTERED_STARTS - unobtainable
			event_target:global_event_country = {
				set_variable = {
					which = acemod_crisis_manager_var_country_empire_placement
					value = 404
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_empire_placement
						value = prev
					}
				}
			}
			# CARAVANEERS_LABEL
			event_target:global_event_country = {
				if = {
					limit = {
						caravaneers_enabled = yes
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_caravaneers_enabled
						value = 1
					}
				}
				else = {
					set_variable = {
						which = acemod_crisis_manager_var_country_caravaneers_enabled
						value = 0
					}
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_caravaneers_enabled
						value = prev
					}
				}
			}
			# XENO_COMPATIBILITY_LABEL
			event_target:global_event_country = {
				if = {
					limit = {
						xeno_compatibility_enabled = yes
					}
					set_variable = {
						which = acemod_crisis_manager_var_country_xeno_compatibility_enabled
						value = 1
					}
				}
				else = {
					set_variable = {
						which = acemod_crisis_manager_var_country_xeno_compatibility_enabled
						value = 0
					}
				}
				root = {
					# Save to root country so that variables can be displayed on Debug window via scripted_loc.
					set_variable = {
						which = acemod_crisis_manager_var_country_xeno_compatibility_enabled
						value = prev
					}
				}
			}
		}
	}
}

# Shows information about galaxy as configured in the game lobby.
country_event = {
	id = acemod_crisis_manager.4
	title = acemod_crisis_manager.4.name
	desc = acemod_crisis_manager.4.desc
	picture = GFX_evt_spy_orb
	is_triggered_only = yes
	option = {
		name = acemod_crisis_manager.4.a
		custom_tooltip = acemod_crisis_manager.4.a.tooltip
	}
}

# Debugging tool.
country_event = {
	id = acemod_crisis_manager.5
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
			country_event = {
				id = acemod_crisis_manager.6				# Debugging event.
				days = 0
				random = 0
			}
			country_event = {
				id = acemod_crisis_manager.7				# Debug output.
				days = 0
				random = 0
			}
		}
	}
}

# Debugging event.
country_event = {
	id = acemod_crisis_manager.6
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		hidden_effect = {
		}
	}
}

# Debug output.
country_event = {
	id = acemod_crisis_manager.7
	title = acemod_crisis_manager.7.name
	desc = acemod_crisis_manager.7.desc
	picture = GFX_evt_glitchy_matrix
	is_triggered_only = yes
	option = {
		name = acemod_crisis_manager.7.a
		custom_tooltip = acemod_crisis_manager.7.a.tooltip
	}
}

# CRISIS TRIGGERS
# Core crisis trigger event. Mirror of crisis_trigger.1
# 
# Dummy event to remove errors in Stellaris log file. DO NOT USE.
event = {
	id = acemod_crisis_manager.1500
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		set_global_flag = a_deadly_tempest_mod_active		# A Deadly Tempest
		set_global_flag = z_cm_installed		# Infinite Crisis Master
		set_global_flag = CmtFlagActivated		# NaK1119's Crisis Manager (all editions + unofficial)
		set_global_flag = acot_override_activated		# Ancient Cache of Technologies: Override
		set_global_flag = nhsc_v30		# Extra Ship Components 3.0
		set_global_flag = nhsc_fe_planets_updated		# Extra Ship Components 3.0 - Overwrites
		set_global_flag = has_real_space_mod		# Real Space
		set_global_flag = z_framework_installed		# Infinite Stellaris Framework
		set_global_flag = galactic_community_formed		# missing vanilla flag?
	}
}

# Marks Aggresive Crisis Engine Mod Manager mod as present. Other mods can check against this flag to see if ACEMOD is installed. on_game_start
country_event = {
	id = acemod_crisis_manager.2000
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_ai = no
	}
	immediate = {
		set_global_flag = acemod_crisis_manager_installed
	}
}